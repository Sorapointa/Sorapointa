# 数据库操作安全

## 事务

在非必须时禁止使用嵌套使用 `transaction`，这会导致 `READ_COMMITTED` 
及以上的事物隔离级别启动的会话**无法读取到嵌套事务内的任何变更**，
以造成各种不符合预期和难以预测的结果，
所以**不能在 API 方法内创建事务**，
事务**必须保证是被最外层应用端调用**，而非底层。

事务执行过程中发生任何错误都会使得整个事务的操作被回滚。

### 事务隔离

对于上述要求的原因是，`READ_COMMITTED` 隔离级别在 `PostgreSQL` 中，
在 `READ_COMMITTED` 事务中的查询看到的是事务开始时的快照，
而不是该事务内部当前查询开始时的快照，这样，单个事务内部的 `SELECT` 命令总是看到同样的数据，
也就是说，它们看不到它们自身事务开始之后提交的其他事务所做出的改变。

所以如果使用嵌套事务，将会使得外层事务无法看到内层事务的更新，并进一步造成不符合预期的结果。

请参考 [PostgreSQL 手册 - 事务隔离](http://www.postgres.cn/docs/9.3/transaction-iso.html)

### 事务的异步

在任何一个事务中都禁止使用任何异步方法来操作数据库，
异步在事务是允许的，但是不允许在同一事务中切线程 / 协程操作数据库，
这会在高并发时造成死锁，在同一事务内所有数据库操作要求必须在同一线程下同步执行。

## 表结构安全

表结构确定了之后最好不要进行任何修改（包括删除字段，修改字段的属性），
因为这需要用户手动同步，只有增加字段的操作可以被自动更新。

## API 安全

任何提供给上层的封装后的数据库操作都**不要自己启动事务**，
这会造成事务的嵌套，并引发在上面提到由于事务隔离所产生的问题。

数据操作方法都必须标注为 `suspend` 方法，
并且通过 `@Suppress("RedundantSuspendModifier")` 抑制警告
